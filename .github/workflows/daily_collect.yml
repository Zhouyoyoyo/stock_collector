name: daily-collect

on:
  schedule:
    - cron: "10 7 * * 1-5"
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    env:
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
      ALERT_EMAIL_FROM: ${{ secrets.SMTP_FROM }}
      ALERT_EMAIL_TO: ${{ secrets.SMTP_TO }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      PHONE_NUM: ${{ secrets.PHONE_NUM }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r stock_collector/requirements.txt

      - name: Install Playwright
        run: python -m playwright install --with-deps chromium

      - name: Restore CSV cache
        uses: actions/cache@v4
        with:
          path: stock_collector/data/csv/**
          key: stock-csv-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            stock-csv-${{ runner.os }}-

      - name: Check SMTP env injection (safe)
        run: |
          python - << 'EOF'
          import os
          keys = [
              "SMTP_HOST",
              "SMTP_PORT",
              "SMTP_USER",
              "SMTP_PASS",
              "ALERT_EMAIL_FROM",
              "ALERT_EMAIL_TO",
          ]
          for k in keys:
              print(f"[env-check] {k} =", "SET" if os.getenv(k) else "MISSING")
          EOF

      - name: Run collector
        run: python stock_collector/main.py --run

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stock-collector-artifacts
          path: |
            stock_collector/data/debug_bundle/**
            stock_collector/data/csv/**
            stock_collector/data/summary/*.json
