name: daily-collect

on:
  schedule:
    - cron: "10 7 * * 1-5"
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    env:
      SMTP_USER: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
      ALERT_EMAIL_FROM: ${{ secrets.SMTP_FROM }}
      ALERT_EMAIL_TO: ${{ secrets.SMTP_TO }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r stock_collector/requirements.txt

      - name: Install Playwright
        run: python -m playwright install --with-deps chromium

      - name: Restore DB cache
        uses: actions/cache@v4
        with:
          path: stock_collector/data/stock_daily.db
          key: stock-db-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            stock-db-${{ runner.os }}-

      - name: Run collector
        run: python stock_collector/main.py --run

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stock-collector-data
          path: |
            stock_collector/data/stock_daily.db
            stock_collector/data/summary/*.json
            stock_collector/data/backup/**
